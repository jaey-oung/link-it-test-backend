name: Deploy to NCP

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 코드 체크아웃
    - uses: actions/checkout@v3
    
    # JDK 21 설치
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
    
    # Gradle wrapper 실행 권한 부여
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    # Gradle로 프로젝트 빌드
    - name: Build with Gradle
      run: ./gradlew build -x test
    
    # NCR(Naver Container Registry) 로그인
    - name: Login to NCR
      run: |
        echo ${{ secrets.NCR_ACCESS_KEY }} | docker login ${{ secrets.NCR_REGISTRY }} \
          -u ${{ secrets.NCR_ACCESS_KEY_ID }} \
          --password-stdin
    
    # Docker 이미지 빌드 및 NCR에 푸시
    - name: Build and Push Docker Image
      run: |
        IMAGE_TAG=${{ secrets.NCR_REGISTRY }}/link-it-backend:${{ github.sha }}
        docker build -t $IMAGE_TAG .
        docker push $IMAGE_TAG
        docker tag $IMAGE_TAG ${{ secrets.NCR_REGISTRY }}/link-it-backend:latest
        docker push ${{ secrets.NCR_REGISTRY }}/link-it-backend:latest

    # 서버에서 Docker 컨테이너 배포
    - name: Deploy on NCP
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.NCP_HOST }}
        username: root
        key: ${{ secrets.NCP_SSH_KEY }}
        command_timeout: 30m
        script: |
          cd /home/ubuntu/app
          
          cat > .env << 'EOF'
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          DB_NAME=linkitdb
          DB_USER=linkituser
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          EOF
          
          echo ${{ secrets.NCR_ACCESS_KEY }} | docker login ${{ secrets.NCR_REGISTRY }} \
            -u ${{ secrets.NCR_ACCESS_KEY_ID }} \
            --password-stdin
          
          docker compose -f docker-compose.prod.yml down || true
          
          docker pull ${{ secrets.NCR_REGISTRY }}/link-it-backend:latest
          
          docker compose -f docker-compose.prod.yml up -d
          
          docker image prune -f